<h2>Live ƒ∞mtahan Lobby</h2>

<div style="margin: 12px 0;">
  <div style="font-size:18px;">
    <b>Game PIN:</b>
    <span style="font-size:28px; letter-spacing: 4px;">{{ session.pin }}</span>
  </div>

  <div style="margin-top:10px;">
    <b>QR il…ô qo≈üul:</b><br/>
    <img src="{{ qr_url }}" alt="QR code" style="width:220px;height:220px;border:1px solid #ddd;border-radius:10px;padding:8px;">
  </div>

  <div style="margin-top:10px;">
    <b>Link:</b>
    <a href="{{ join_url }}" target="_blank">{{ join_url }}</a>
  </div>
</div>

<hr>

<!-- ‚úÖ Host control buttons -->
<div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
  <button id="startBtn">Start Game</button>
  <button id="nextBtn" disabled>Next Question</button>
  <button id="revealBtn" disabled>Reveal</button>
  <button id="finishBtn">Finish</button>

  <label style="margin-left:10px;">
    <input type="checkbox" id="autoMode" checked>
    Auto (vaxt bit…ônd…ô reveal + sonra next)
  </label>

  <span id="gameState" style="margin-left:8px;opacity:.8;">state: lobby</span>
</div>

<!-- ‚úÖ Host-da da sual g√∂r√ºns√ºn -->
<div id="questionWrap" style="display:none;margin-top:12px;max-width:980px;border:1px solid #eee;border-radius:12px;padding:12px;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
    <div style="font-weight:700;font-size:18px;">Sual Preview</div>
    <div style="font-weight:700;border:1px solid #eee;border-radius:999px;padding:6px 12px;">
      ‚è≥ <span id="qTimer">--</span>
    </div>
  </div>

  <div id="qMeta" style="margin-top:6px;opacity:.75;"></div>

  <div id="qText" style="margin-top:10px;font-size:20px;font-weight:800;"></div>

  <div id="qOptions" style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px;"></div>
</div>

<div id="hostLog"
     style="margin-top:10px;padding:10px;border:1px solid #eee;border-radius:10px;white-space:pre-wrap;max-width:980px;">
  Ready.
</div>

<hr>

<h3>Qo≈üulanlar</h3>
<div><b>Say:</b> <span id="playersCount">0</span></div>
<ul id="playersList"></ul>

<hr>

<!-- ‚úÖ Reveal sonrasƒ± host √º√ß√ºn leaderboard -->
<div id="leaderWrap" style="display:none;max-width:980px;border:1px solid #eee;border-radius:12px;padding:12px;">
  <h3 style="margin:0 0 10px;">üèÜ Leaderboard</h3>
  <ol id="leaderList" style="margin:0;padding-left:18px;"></ol>

  <div style="margin-top:12px;">
    <div style="display:inline-block;border:1px solid #eee;border-radius:999px;padding:5px 10px;opacity:.8;font-size:12px;">
      Bu sual √ºzr…ô n…ôtic…ôl…ôr
    </div>
    <ol id="resultList" style="margin-top:10px;padding-left:18px;"></ol>
  </div>
</div>

<script>
  const pin = "{{ session.pin }}";
  const csrf = "{{ csrf_token }}";

  const hostLog = document.getElementById("hostLog");
  const gameStateEl = document.getElementById("gameState");

  const startBtn = document.getElementById("startBtn");
  const nextBtn = document.getElementById("nextBtn");
  const revealBtn = document.getElementById("revealBtn");
  const finishBtn = document.getElementById("finishBtn");
  const autoModeEl = document.getElementById("autoMode");

  const leaderWrap = document.getElementById("leaderWrap");
  const leaderList = document.getElementById("leaderList");
  const resultList = document.getElementById("resultList");

  // Question preview elements
  const questionWrap = document.getElementById("questionWrap");
  const qTimerEl = document.getElementById("qTimer");
  const qMetaEl = document.getElementById("qMeta");
  const qTextEl = document.getElementById("qText");
  const qOptionsEl = document.getElementById("qOptions");

  function logLine(s){
    hostLog.textContent = (hostLog.textContent + "\n" + s).trim();
  }

  function wsUrl(path){
    const proto = location.protocol === "https:" ? "wss" : "ws";
    return `${proto}://${location.host}${path}`;
  }

  async function postAction(url){
    const res = await fetch(url, {
      method: "POST",
      headers: { "X-CSRFToken": csrf, "X-Requested-With": "XMLHttpRequest", "Accept": "application/json" }
    });
    const data = await res.json().catch(()=>({}));
    if (!res.ok) throw new Error(data.message || "HTTP error");
    return data;
  }

  // --------------------------
  // Lobby WS (qo≈üulanlar)
  // --------------------------
  const lobbyWs = new WebSocket(wsUrl(`/ws/live/${pin}/lobby/`));
  lobbyWs.onopen = () => logLine("‚úÖ Lobby WS qo≈üuldu");
  lobbyWs.onclose = () => logLine("‚ùå Lobby WS k…ôsildi");
  lobbyWs.onerror = () => logLine("‚ùå Lobby WS error");

  lobbyWs.onmessage = (e) => {
    const data = JSON.parse(e.data);

    if (data.type === "lobby_state") {
      document.getElementById("playersCount").textContent = data.count || 0;
      const ul = document.getElementById("playersList");
      ul.innerHTML = "";
      (data.players || []).forEach(p => {
        const li = document.createElement("li");
        li.textContent = `${p.nickname} (${p.avatar_key})`;
        ul.appendChild(li);
      });
    }
  };

  // --------------------------
  // Play WS (sual/reveal/finish)
  // --------------------------
  const playWs = new WebSocket(wsUrl(`/ws/live/${pin}/play/`));
  playWs.onopen = () => logLine("‚úÖ Play WS qo≈üuldu");
  playWs.onclose = () => logLine("‚ùå Play WS k…ôsildi");
  playWs.onerror = () => logLine("‚ùå Play WS error");

  // UI state
  let state = "lobby";
  let currentQuestion = null;
  let qTimerInterval = null;

  // auto timers
  let autoRevealTimer = null;
  let autoNextTimer = null;

  function clearAutoTimers(){
    if (autoRevealTimer) clearTimeout(autoRevealTimer);
    if (autoNextTimer) clearTimeout(autoNextTimer);
    autoRevealTimer = null;
    autoNextTimer = null;
  }

  function clearQuestionTimer(){
    if (qTimerInterval) clearInterval(qTimerInterval);
    qTimerInterval = null;
    qTimerEl.textContent = "--";
  }

  function setState(newState){
    state = newState;
    gameStateEl.textContent = "state: " + state;

    if (state === "lobby") {
      startBtn.disabled = false;
      revealBtn.disabled = true;
      nextBtn.disabled = true;
      questionWrap.style.display = "none";
      leaderWrap.style.display = "none";
      clearQuestionTimer();
      clearAutoTimers();
    }

    if (state === "question") {
      startBtn.disabled = true;
      revealBtn.disabled = false;
      nextBtn.disabled = true;
      leaderWrap.style.display = "none";
    }

    if (state === "reveal") {
      startBtn.disabled = true;
      revealBtn.disabled = true;
      nextBtn.disabled = false;
      clearQuestionTimer();
    }

    if (state === "finished") {
      startBtn.disabled = true;
      revealBtn.disabled = true;
      nextBtn.disabled = true;
      clearQuestionTimer();
      clearAutoTimers();
    }
  }

  function fmt2(n){ return String(n).padStart(2, "0"); }

  function startQuestionTimer(endsAtISO){
    clearQuestionTimer();
    if (!endsAtISO) return;

    const ends = new Date(endsAtISO).getTime();

    function tick(){
      const diff = Math.max(0, ends - Date.now());
      const sec = Math.ceil(diff / 1000);
      const mm = Math.floor(sec / 60);
      const ss = sec % 60;
      qTimerEl.textContent = `${fmt2(mm)}:${fmt2(ss)}`;

      if (diff <= 0){
        qTimerEl.textContent = "00:00";
        clearQuestionTimer();
      }
    }

    tick();
    qTimerInterval = setInterval(tick, 250);
  }

  function renderQuestionPreview(q){
    currentQuestion = q;
    questionWrap.style.display = "block";

    qMetaEl.textContent = (q?.index && q?.total) ? `Sual: ${q.index}/${q.total} ‚Äî id=${q.id}` : `id=${q.id}`;
    qTextEl.textContent = q?.text || "";

    qOptionsEl.innerHTML = "";
    const letters = ["A","B","C","D","E","F"];

    (q.options || []).forEach((opt, idx) => {
      const label = (opt.label ?? opt.key ?? opt.code ?? letters[idx] ?? String(idx+1));
      const text  = (opt.text ?? opt.title ?? opt.content ?? "").toString();

      const div = document.createElement("div");
      div.style.border = "1px solid #eee";
      div.style.borderRadius = "12px";
      div.style.padding = "12px";
      div.style.opacity = ".95";
      div.textContent = `${label}) ${text}`;
      qOptionsEl.appendChild(div);
    });

    startQuestionTimer(q.ends_at);
  }

  function renderHostLeaderboard(top, results){
    leaderWrap.style.display = "block";
    leaderList.innerHTML = "";
    resultList.innerHTML = "";

    (top || []).forEach((p, i) => {
      const li = document.createElement("li");
      li.textContent = `${i+1}. ${p.nickname} ‚Äî ${p.score} bal`;
      leaderList.appendChild(li);
    });

    (results || []).slice(0, 30).forEach(r => {
      const li = document.createElement("li");
      li.textContent = `${r.nickname}: ${r.is_correct ? "‚úÖ" : "‚ùå"} +${r.awarded_points} (total ${r.total_score})`;
      resultList.appendChild(li);
    });
  }

  // ‚úÖ WS messages
  playWs.onmessage = (e) => {
    const msg = JSON.parse(e.data);

    if (msg.type === "question_published") {
      setState("question");
      renderQuestionPreview(msg.question);

      logLine(`üìå Sual yayƒ±mlandƒ±: #${msg.question?.index}/${msg.question?.total} (id=${msg.question?.id})`);
      logLine(`‚è≥ ends_at: ${msg.question?.ends_at}`);

      // ‚úÖ AUTO: vaxt bit…ônd…ô reveal
      clearAutoTimers();
      if (autoModeEl?.checked && msg.question?.ends_at) {
        const ends = new Date(msg.question.ends_at).getTime();
        const ms = Math.max(0, ends - Date.now());

        autoRevealTimer = setTimeout(async () => {
          try {
            if (state !== "question") return;
            logLine("‚è≥ Auto Reveal (time ended)...");
            await postAction("{% url 'liveExam:end_question' session.pin %}");
          } catch(e){
            logLine("‚ùå Auto Reveal error: " + e.message);
          }
        }, ms + 80);
      }

      return;
    }

    if (msg.type === "answer_progress") {
      // BONUS: hamƒ± cavab veribs…ô d…ôrhal reveal
      logLine(`üßÆ Answers: ${msg.answered_count}/${msg.total_players}`);

      if (autoModeEl?.checked && state === "question" && msg.total_players > 0 && msg.answered_count >= msg.total_players) {
        clearAutoTimers();
        (async () => {
          try {
            if (state !== "question") return;
            logLine("‚ö° Auto Reveal (all answered)...");
            await postAction("{% url 'liveExam:end_question' session.pin %}");
          } catch(e){
            logLine("‚ùå Auto Reveal(all) error: " + e.message);
          }
        })();
      }
      return;
    }

    if (msg.type === "reveal") {
      setState("reveal");
      renderHostLeaderboard(msg.top || [], msg.results || []);
      logLine(`üèÅ Reveal: question_id=${msg.question_id}`);

      // ‚úÖ AUTO: reveal-dan sonra next
      clearAutoTimers();
      if (autoModeEl?.checked) {
        autoNextTimer = setTimeout(async () => {
          try {
            if (state !== "reveal") return;
            logLine("‚è≠Ô∏è Auto Next...");
            await postAction("{% url 'liveExam:next_question' session.pin %}");
          } catch(e){
            logLine("‚ùå Auto Next error: " + e.message);
          }
        }, 3500);
      }

      return;
    }

    if (msg.type === "finished") {
      setState("finished");
      renderHostLeaderboard(msg.top || [], []);
      logLine("‚úÖ Oyun bitdi");
      return;
    }
  };

  // --------------------------
  // Button actions
  // --------------------------
  startBtn.onclick = async () => {
    try {
      logLine("‚ñ∂Ô∏è Start Game...");
      const data = await postAction("{% url 'liveExam:start_game' session.pin %}");
      logLine("‚úÖ Started: " + JSON.stringify(data));
    } catch(e){
      logLine("‚ùå " + e.message);
    }
  };

  revealBtn.onclick = async () => {
    try {
      logLine("üëÄ Reveal...");
      await postAction("{% url 'liveExam:end_question' session.pin %}");
      logLine("‚úÖ Reveal sent");
    } catch(e){
      logLine("‚ùå " + e.message);
    }
  };

  nextBtn.onclick = async () => {
    try {
      logLine("‚è≠Ô∏è Next Question...");
      const data = await postAction("{% url 'liveExam:next_question' session.pin %}");
      logLine("‚úÖ Next: " + JSON.stringify(data));
    } catch(e){
      logLine("‚ùå " + e.message);
    }
  };

  finishBtn.onclick = async () => {
    try {
      logLine("üèÅ Finish...");
      await postAction("{% url 'liveExam:finish_game' session.pin %}");
      logLine("‚úÖ Finished");
      setState("finished");
    } catch(e){
      logLine("‚ùå " + e.message);
    }
  };

  setState("lobby");
</script>
