{% extends "base.html" %}
{% load static %}

{% block title %}{{ exam.title }} - Redaktə{% endblock %}

{% block extraCss %}
    <link rel="stylesheet" href="{% static 'css/edit_exam.css' %}">
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1>"{{ exam.title }}" imtahanını redaktə et</h1>

    <form method="post">
        {% csrf_token %}

        {# Ümumi forma xətaları #}
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <div class="mb-3">
            {{ form.title.label_tag }}
            {{ form.title }}
            {{ form.title.errors }}
        </div>

        <div class="mb-3">
            {{ form.description.label_tag }}
            {{ form.description }}
            {{ form.description.errors }}
        </div>

        <div class="mb-3">
            {{ form.exam_type.label_tag }}
            {{ form.exam_type }}
            {{ form.exam_type.errors }}
        </div>

        <div class="form-check mb-3 form-exam-checkbox">
            {{ form.is_active }}
            {{ form.is_active.label_tag }}
            {{ form.is_active.errors }}
        </div>

        <div class="mb-3">
            {{ form.total_duration_minutes.label_tag }}
            {{ form.total_duration_minutes }}
            {{ form.total_duration_minutes.errors }}
        </div>

        <div class="mb-3">
            {{ form.default_question_time_seconds.label_tag }}
            {{ form.default_question_time_seconds }}
            {{ form.default_question_time_seconds.errors }}
        </div>
 
        <div class="mb-3">
            {{ form.max_attempts_per_user.label_tag }}
            {{ form.max_attempts_per_user }}
            {{ form.max_attempts_per_user.errors }}
        </div>

        {# ================= GİRİŞ HÜQUQLARI BLOKU (YENİLƏNMİŞ) ================= #}
        <hr class="my-4">

        <h3 class="mb-2">Giriş hüquqları</h3>
        <p class="text-muted mb-3" style="font-size: 0.9rem;">
            İmtahanı kimlərin görə biləcəyini burada idarə et.
        </p>

        {# Hamı üçün açıq? #}
        <div class="form-check mb-3 form-exam-checkbox">
            {{ form.is_public }}
            {{ form.is_public.label_tag }}
            {{ form.is_public.errors }}
            <small class="text-muted d-block" style="font-size: 0.85rem;">
                İşarələsən, imtahan bütün tələbələrə açıq olacaq.
            </small>
        </div>

        {# Qrup və fərdi istifadəçi seçimi (CUSTOM SEARCHABLE UI) #}
        <div id="access-restrictions" class="mb-3 p-3 border rounded">
            <div class="row">
                
                <div class="col-md-6 mb-3 custom-selector-group">
                    <label class="form-label-custom">İcazəli Qruplar</label>
                    
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="groupSearchInput" class="custom-search-input" placeholder="Qrup axtar...">
                    </div>

                    <div id="groupListContainer" class="custom-list-container">
                        <div class="loading-text">Yüklənir...</div>
                    </div>

                    <div class="selection-counter">
                        Seçilib: <span id="groupSelectedCount">0</span>
                    </div>

                    <div style="display: none;">{{ form.allowed_groups }}</div>
                    {{ form.allowed_groups.errors }}
                </div>

                <div class="col-md-6 mb-3 custom-selector-group">
                    <label class="form-label-custom">Fərdi İcazəli Tələbələr</label>
                    
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="userSearchInput" class="custom-search-input" placeholder="Tələbə axtar...">
                    </div>

                    <div id="userListContainer" class="custom-list-container">
                        <div class="loading-text">Yüklənir...</div>
                    </div>

                    <div class="selection-counter">
                        Seçilib: <span id="userSelectedCount">0</span>
                    </div>

                    <div style="display: none;">{{ form.allowed_users }}</div>
                    {{ form.allowed_users.errors }}
                </div>
            </div>

            <p class="text-muted mb-0" style="font-size: 0.8rem;">
                <i class="fas fa-info-circle me-1"></i>
                Heç qrup və istifadəçi seçməsən, amma <strong>“Hamı üçün açıqdır?”</strong>
                işarəli deyilsə, imtahan heç kimə görünməyəcək.
            </p>
        </div>

        {# İmtahan kodu #}
        <div class="mb-3">
            {{ form.access_code.label_tag }}
            {{ form.access_code }}
            {{ form.access_code.errors }}
            <small class="text-muted d-block" style="font-size: 0.85rem;">
                Optional: 6 rəqəmli kod.
            </small>
        </div>
        {# ================= GİRİŞ HÜQUQLARI BLOKU SON ================= #}

        <div class="mt-4 d-flex">
            <button type="submit" class="btn btn-success">Yadda saxla</button>
            <a href="{% url 'teacher_exam_detail' exam.slug %}" class="btn btn-secondary ms-2">
                Ləğv et
            </a>
        </div>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        
        // 1. PUBLIC/PRIVATE TOGGLE ANIMASIYALI
        const isPublicCheckbox = document.getElementById("{{ form.is_public.id_for_label }}");
        const accessBlock = document.getElementById("access-restrictions");

        function toggleAccessBlock() {
            if (!isPublicCheckbox || !accessBlock) return;
            
            if (isPublicCheckbox.checked) {
                // Hamı üçün açıqdırsa -> Blok bağlansın (Klass əlavə et)
                accessBlock.classList.add('closed');
            } else {
                // Hamı üçün açıq deyilsə -> Blok açılsın (Klassı sil)
                accessBlock.classList.remove('closed');
            }
        }

        if (isPublicCheckbox) {
            // Səhifə yüklənəndə ilkin vəziyyəti yoxla
            toggleAccessBlock();
            
            // Dəyişiklik olanda funksiyanı çağır
            isPublicCheckbox.addEventListener("change", toggleAccessBlock);
        }

        // ... (Sizin digər setupCustomSelector funksiyalarınız burada qalır) ...
        
        // 2. SEARCHABLE MULTI-SELECT FUNCTION (Bura toxunmuruq, olduğu kimi qalır)
        function setupCustomSelector(selectId, containerId, searchInputId, counterId) {
            // ... (Köhnə kodunuz eynilə qalır) ...
            const hiddenSelect = document.getElementById(selectId);
            const container = document.getElementById(containerId);
            const searchInput = document.getElementById(searchInputId);
            const counterSpan = document.getElementById(counterId);

            if (!hiddenSelect || !container) return;

            function buildList() {
                container.innerHTML = '';
                const options = Array.from(hiddenSelect.options);

                if (options.length === 0) {
                    container.innerHTML = '<div class="loading-text">Məlumat yoxdur</div>';
                    return;
                }

                options.forEach(option => {
                    const row = document.createElement('div');
                    row.className = 'list-item-row';
                    row.setAttribute('data-search', option.text.toLowerCase());
                    const checkboxId = `cb_${selectId}_${option.value}`;

                    row.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" class="custom-item-checkbox" value="${option.value}" ${option.selected ? 'checked' : ''}>
                        <label for="${checkboxId}" class="custom-item-label">${option.text}</label>
                    `;
                    const checkbox = row.querySelector('input');

                    checkbox.addEventListener('change', function() {
                        option.selected = this.checked;
                        updateCounter();
                    });

                    row.addEventListener('click', function(e) {
                        if (e.target !== checkbox && e.target.tagName !== 'LABEL') {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                    container.appendChild(row);
                });
            }

            function updateCounter() {
                if (counterSpan) {
                    counterSpan.textContent = hiddenSelect.selectedOptions.length;
                }
            }

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const filter = this.value.toLowerCase();
                    const rows = container.querySelectorAll('.list-item-row');
                    rows.forEach(row => {
                        const text = row.getAttribute('data-search');
                        row.style.display = text.includes(filter) ? 'flex' : 'none';
                    });
                });
            }

            buildList();
            updateCounter();
        }

        // Qruplar və Userlər üçün funksiyanı çağırırıq
        setupCustomSelector("id_allowed_groups", "groupListContainer", "groupSearchInput", "groupSelectedCount");
        setupCustomSelector("id_allowed_users", "userListContainer", "userSearchInput", "userSelectedCount");
    });
</script>
{% endblock %}