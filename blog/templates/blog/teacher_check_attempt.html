{% extends "base.html" %}
{% load static %}

{% block title %}{{ exam.title }} - Yoxlama{% endblock %}

{% block extraCss %} 
    <link rel="stylesheet" href="{% static 'css/teacher_check_attempt.css' %}">
{% endblock %}

{% block content %}
<div class="review-container">
    <div class="exam-header">
        <h1>{{ exam.title }} – Yoxlama</h1>
    </div>

    <form method="post" id="gradingForm">
        {% csrf_token %}
        <ul class="questions-grid">
            {% for item in qa_list %}
                {% with q=item.question ans=item.answer %}
                    <li class="question-card" data-question-id="{{ q.id }}">
                        <div class="question-card-header">
                            <span>Sual #{{ forloop.counter }}</span>

                            <span class="status-badge 
                                {% if not ans %}
                                    status-empty
                                {% elif ans.teacher_score is not None %}
                                    status-scored
                                {% elif not ans.text_answer %}
                                    status-empty
                                {% else %}
                                    status-not-checked
                                {% endif %}" 
                                id="badge_{{ q.id }}">
                                
                                {% if not ans %}
                                    Cavab yoxdur
                                {% elif ans.teacher_score is not None %}
                                    {{ ans.teacher_score }} Bal
                                {% elif not ans.text_answer %}
                                    Boş Cavab
                                {% else %}
                                    Yoxlanmayıb
                                {% endif %}
                            </span>
                        </div>

                        <p class="mb-2">{{ q.text|truncatewords:8 }}</p>

                        {# ---- GİZLİ SCORE INPUT ---- #}
                        <input type="hidden"
                               id="hidden_score_{{ q.id }}"
                               name="score_{{ q.id }}" 
                               value="{% if ans and ans.teacher_score is not None %}{{ ans.teacher_score }}{% endif %}">
                        
                        {# ---- GİZLİ FEEDBACK TEXTAREA ---- #}
                        <textarea style="display:none;"
                                  id="hidden_feedback_{{ q.id }}"
                                  name="feedback_{{ q.id }}">{% if ans %}{{ ans.teacher_feedback }}{% endif %}</textarea>

                        {# ---- JS ÜÇÜN MƏLUMAT STORAGE ---- #}
                        <div class="data-store" style="display:none;"
                             data-q-text="{{ q.text|escape }}"
                             data-ans-text="{% if ans %}{{ ans.text_answer|escape }}{% else %}{% endif %}">
                        </div>

                        <div class="answer-preview">
                            {% if ans and ans.text_answer %}
                                {{ ans.text_answer|truncatewords:10 }}
                        
                            {% elif ans and ans.paint_image %}
                                <span class="answered-with-paint">
                                    <i class="fas fa-paint-brush"></i> Paint ilə cavab verilib
                                </span>
                        
                            {% else %}
                                <span class="not-answered">Cavab yoxdur</span>
                            {% endif %}
                        </div>
                        

                        {# ====== YENİ: YÜKLƏNMİŞ FAYLLAR BLOKU ====== #}
                        {% if ans and ans.files.all %}
                            <div class="answer-files">
                                <span class="files-title">Yüklənmiş fayllar:</span>
                                <ul class="file-list">
                                    {% for f in ans.files.all %}
                                        {% with name=f.filename|lower %}
                                            <li class="file-item">
                                                <span class="file-icon">
                                                    {% if ".pdf" in name %}
                                                        <i class="fas fa-file-pdf"></i>
                                                    {% elif ".zip" in name %}
                                                        <i class="fas fa-file-archive"></i>
                                                    {% elif ".png" in name or ".jpg" in name or ".jpeg" in name or ".gif" in name %}
                                                        <i class="fas fa-image"></i>
                                                    {% else %}
                                                        <i class="fas fa-file"></i>
                                                    {% endif %}
                                                </span>
                                                
                                                <a href="{{ f.file.url }}" 
                                                   target="_blank" 
                                                   class="file-link">
                                                    {{ f.filename }}
                                                </a>

                                                {# Şəkillər üçün kiçik inline preview #}
                                                {% if ".png" in name or ".jpg" in name or ".jpeg" in name or ".gif" in name %}
                                                    <div class="file-thumb">
                                                        <img src="{{ f.file.url }}" 
                                                             alt="{{ f.filename }}">
                                                    </div>
                                                {% endif %}
                                            </li>
                                        {% endwith %}
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        {# ====== /YENİ BLOK ====== #}
                       {# ====== PAINT CAVABI (ExamAnswer.paint_image) ====== #}
                        {% if ans and ans.paint_image %}
                        <div class="paint-preview-section">
                        <h4>
                            <i class="fas fa-paint-brush"></i>
                            Paint Cavabı
                            {% if ans.paint_updated_at %}
                                <small style="opacity:.7; font-weight:400;">({{ ans.paint_updated_at|date:"d.m.Y H:i" }})</small>
                            {% endif %}
                                </h4>

                                <a href="{{ ans.paint_image.url }}" target="_blank" class="paint-open-link">
                                    <img src="{{ ans.paint_image.url }}" alt="Paint" class="paint-preview-img">
                                </a>
                                </div>
                        {% endif %}
                        {# ====== /PAINT CAVABI ====== #}

                    </li>
                {% endwith %}
            {% endfor %}
        </ul>

        <div class="main-actions sticky-bottom">
            <a href="{% url 'teacher_exam_results' exam.slug %}" class="btn btn-secondary" id="backBtn">
                <i class="fas fa-arrow-left"></i> Geri
            </a>
            <button type="submit" class="btn btn-success" id="mainSaveBtn" disabled>
                <i class="fas fa-save"></i> Dəyişiklik yoxdur
            </button>
        </div>
    </form>
</div>

<div class="modal-backdrop" id="modalBackdrop"></div>
<div class="modal-content-wrapper" id="questionModal">
    <div class="modal-header">
        <span id="modalTitle">Sual</span>
        <button type="button" class="close-btn" onclick="attemptCloseModal()">&times;</button>
    </div>
    <div class="modal-body">
        <div class="question-detail" id="modalQuestionText"></div>
        <div class="answer-detail" id="modalAnswerText"></div>
        
        <div class="grading-area">
            <label>Bal:</label>
            <input type="number" id="modalScoreInput" class="form-control mb-2">
            
            <label>Rəy:</label>
            <textarea id="modalFeedbackInput" rows="3" class="form-control"></textarea>
            
            <input type="hidden" id="currentQuestionId">
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="attemptCloseModal()">İmtina</button>
        <button type="button" class="btn btn-primary" onclick="saveFromModal()">Təsdiqlə (Müvəqqəti)</button>
    </div>
</div> 

<div class="custom-alert-overlay" id="warningModal" style="display: none;">
    <div class="custom-alert-box">
        <div class="alert-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3>Dəyişikliklər yadda saxlanmadı!</h3>
        <p>Pəncərəni bağlasanız, yazdığınız bal və rəy itəcək. Davam etmək istəyirsiniz?</p>
        <div class="alert-actions">
            <button class="btn btn-secondary" onclick="closeWarningModal()">Xeyr, Qayıt</button>
            <button class="btn btn-danger" onclick="forceCloseModal()">Bəli, Bağla</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extraJs %}
    <script src="{% static 'js/teacher_check_attempt.js' %}"></script>
{% endblock %}
