{% extends "base.html" %}
{% load static %}

{% block title %}{{ profile_user.username }} | Profil{% endblock %}

{% block extraCss %}
    <link rel="stylesheet" href="{% static 'css/profile.css' %}">
    <link rel="stylesheet" href="{% static 'css/blogCard.css' %}">
    <link rel="stylesheet" href="{% static 'css/pagination.css' %}"> {# Pagination CSS-i üçün #}
{% endblock %}

{% block content %}
<div class="profile-page-wrapper">
    <header class="profile-section-header">
        <h1><span>{{ profile_user.username }}</span> Profili</h1>
        <p class="profile-subheading">İstifadəçinin yaratdığı məqalələr</p>

        {% if request.user.is_authenticated and request.user == profile_user %}
             <a href="{% url 'create_post' %}" class="profile-create-post-btn">
               <i class="fas fa-plus-circle"></i> Yeni post yarat
             </a>

             {% if request.user.is_teacher %}
                 <a href="{% url 'teacher_exam_list' %}" class="profile-create-post-btn">
                      <i class="fas fa-file-alt"></i> İmtahanlarım
                 </a>
                 {% if pending_count > 0 %}
                    <a href="{% url 'teacher_pending_attempts' %}" class="profile-create-post-btn btn-warning-pulse">
                        <i class="fas fa-bell"></i> Yoxlanılacaq
                        <span class="pending-badge">{{ pending_count }}</span>
                    </a>
                 {% endif %}
                 <a href="{% url 'create_exam' %}" class="profile-create-post-btn">
                      <i class="fas fa-plus-square"></i> Yeni imtahan yarat
                 </a>
                 <a href="{% url 'student_exam_history' %}" class="profile-create-post-btn">
                    <i class="fas fa-list-alt"></i> İmtahan Nəticələrim
                </a>
                            {# --- YENİ: Qruplar düymələri --- #}
                <a href="{% url 'teacher_group_list' %}" class="profile-create-post-btn">
                    <i class="fas fa-users"></i> Qruplarım
                </a>

                {% comment %} <a href="{% url 'create_student_group' %}" class="profile-create-post-btn">
                    <i class="fas fa-user-plus"></i> Qrup yarat
                </a> {% endcomment %}
            {% endif %}
        {% endif %}
    </header>

    <section class="profile-posts-section">
        {% if posts %}
            <div class="blog-grid-container"> {# Blog kartlarını grid sistemində göstərmək üçün yeni konteyner #}
                {% for post in posts %}
                    <article class="profile-post-card">
                        {% if request.user == profile_user %}
                            <div class="post-controls">
                                {# Status Etiketi #}
                                <span class="post-status-badge 
                                    {% if post.is_published %}status-published{% else %}status-draft{% endif %}">
                                    {% if post.is_published %}
                                        <i class="fas fa-check-circle"></i> Nəşr olunub
                                    {% else %}
                                        <i class="fas fa-pencil-alt"></i> Qaralama
                                    {% endif %}
                                </span>

                                {# Redaktə və Sil İkonları #}
                                <div class="action-icons">
                                    <button class="icon-action-btn edit-btn js-edit-post"
                                            data-post-id="{{ post.pk }}"
                                            data-title="{{ post.title|escape }}"
                                            data-content="{{ post.content|escape }}"
                                            data-category="{{ post.category.id|default_if_none:'' }}"
                                            data-excerpt="{{ post.excerpt|default_if_none:''|escape }}"
                                            data-image-url="{{ post.image_url|default_if_none:''|escape }}"
                                            data-file-image="{% if post.image %}{{ post.image.url|escape }}{% endif %}"
                                            data-is-published="{{ post.is_published|yesno:'true,false' }}"
                                            data-slug="{{ post.slug|escape }}"
                                            data-created-at="{{ post.created_at|date:'d.m.Y H:i' }}"
                                            data-updated-at="{{ post.updated_at|date:'d.m.Y H:i' }}"
                                            title="Redaktə et">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                
                                    <button class="icon-action-btn delete-btn js-open-delete"
                                            data-post-id="{{ post.pk }}"
                                            data-title="{{ post.title|escape }}"
                                            title="Sil">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                        
                        {% include "partials/_blogCard.html" with post=post %} 
                    </article>
                {% endfor %}
            </div> {# .blog-grid-container sonu #}

            {# Pagination partial əlavə olunur #}
            {% if posts.has_other_pages %}
                {% include "partials/_pagination.html" with page_obj=posts %}
            {% endif %}

        {% else %}
            <p class="profile-no-posts-message">Bu istifadəçinin hələ heç bir postu yoxdur.</p>
        {% endif %}
    </section>
    
    {# MODAL HİSSƏLƏRİ DƏYİŞMİR #}
    {# Edit Modal #}
    <div id="editModal" class="modal-overlay">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Postu Redaktə Et</h3>
                <button class="modal-close-btn" id="closeEditModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            {# Meta məlumat bloku #}
            <div class="form-meta">
                <p><strong>Slug:</strong> <span id="editSlugInfo"></span></p>
                <p><strong>Yaradılma:</strong> <span id="editCreatedAtInfo"></span></p>
                <p><strong>Son yenilənmə:</strong> <span id="editUpdatedAtInfo"></span></p>
            </div>

            <form id="editForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <label for="editTitle">Başlıq</label>
                    <input type="text" id="editTitle" name="title" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="editCategory">Kateqoriya</label>
                    <select id="editCategory" name="category" class="form-control" required>
                        <option value="" disabled>Kateqoriya seçin</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="editExcerpt">Qısa məzmun</label>
                    <textarea id="editExcerpt" name="excerpt" class="form-control" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label for="editContent">Məzmun</label>
                    <textarea id="editContent" name="content" class="form-control" rows="10" required></textarea>
                </div>

                {# Şəkil preview + yeni şəkil + URL #}
                <div class="form-group">
                    <label>Mövcud şəkil</label>
                    <div id="editImagePreviewWrapper" class="image-preview-wrapper">
                        <img id="editImagePreview" src="" alt="Post şəkli" class="image-preview" style="display:none;">
                        <p id="noImageText" class="no-image-text">Şəkil təyin edilməyib</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editImage">Yeni şəkil yüklə (optional)</label>
                    <input type="file" id="editImage" name="image" class="form-control" accept="image/*">
                </div>

                <div class="form-group">
                    <label for="editImageUrl">Şəkil URL (əgər fayl yoxdursa)</label>
                    <input type="url" id="editImageUrl" name="image_url" class="form-control">
                </div>

                <div class="form-group form-check">
                    <label class="checkbox-label">
                        <input type="checkbox" id="editIsPublished" name="is_published">
                        Məqalə dərc olunsun
                    </label>
                </div>

                <div class="modal-buttons">
                    <button type="button" id="cancelEdit" class="modal-cancel-btn">Ləğv Et</button>
                    <button type="submit" id="saveEdit" class="modal-confirm-btn" disabled>Yadda Saxla</button>
                </div>
            </form>
        </div>
    </div>


    {# Delete Confirmation Modal #}
    <div id="deleteModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Silinməni Təsdiqlə</h3>
            <p>Əminsiniz ki, <span id="deleteTitle" class="fw-bold"></span> başlıqlı postu silmək istəyirsiniz?</p>
            <div class="modal-buttons">
                <button id="cancelDelete" class="modal-cancel-btn">Ləğv Et</button>
                {# Burda .delete-btn yalnız dizayn üçündür, JS selektoru artıq .js-open-delete-dir #}
                <button id="confirmDelete" class="modal-confirm-btn delete-btn">Sil</button>
            </div>
        </div>
    </div>

    {# Unsaved Changes Warning Modal #}
    <div id="warningModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Yadda Saxlanılmamış Dəyişikliklər</h3>
            <p>Postda etdiyiniz dəyişikliklər yadda saxlanılmayıb. Saxlamadan çıxmaq istəyirsiniz?</p>
            <div class="modal-buttons">
                <button id="stayOnModal" class="modal-cancel-btn">Qal</button>
                <button id="discardChanges" class="modal-confirm-btn warning-btn">Saxlamadan Çıx</button>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extraJs %}
    <script src="{% static 'js/user_profile.js' %}"></script>
{% endblock %}