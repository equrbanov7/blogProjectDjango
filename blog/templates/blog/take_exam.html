{% extends "base.html" %}
{% load get_item %}
{% load static %}

{% block title %}{{ exam.title }} - İmtahan{% endblock %}

{% block extraCss %}
    {# Bu hissəni əlavə edin və ya mövcud olanı dəyişdirin #}
    <link rel="stylesheet" href="{% static 'css/take_exam.css' %}">
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1>{{ exam.title }}</h1>

    <p class="exam-info">
        Tip: <strong>{{ exam.get_exam_type_display }}</strong><br>
        Müddət:
        {% if exam.total_duration_minutes %}
            <strong>{{ exam.total_duration_minutes }} dəqiqə</strong>
        {% else %}
            <strong>Limitsiz</strong>
        {% endif %}
    </p>

    {% if remaining_seconds %}
        <div id="exam-timer" class="alert alert-info">
            Qalan vaxt: <span id="timer-value"></span>
        </div>
    {% endif %}

    <form method="post" id="exam-form">
        {% csrf_token %}

        <ol class="question-list">
        {% for q in questions %}
            {% with ans=answers_by_qid|get_item:q.id %}
                <li class="question-item">
                    <p class="question-text"><strong>{{ forloop.counter }}. {{ q.text }}</strong></p>

                    {# TEST imtahanı üçün variantlar #}
                    {% if exam.exam_type == "test" %}

                        {% if q.answer_mode == "single" %}
                            <div class="options-group">
                                {% for opt in q.options.all %}
                                    <div class="form-check custom-radio">
                                        <label class="form-check-label">
                                            <input
                                                type="radio"
                                                name="q_{{ q.id }}"
                                                value="{{ opt.id }}"
                                                class="form-check-input"
                                                {% if ans and opt in ans.selected_options.all %}checked{% endif %}
                                            >
                                            <span class="custom-radio-mark"></span>
                                            {{ opt.text }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>

                        {% elif q.answer_mode == "multiple" %}
                            <div class="options-group">
                                {% for opt in q.options.all %}
                                    <div class="form-check custom-checkbox">
                                        <label class="form-check-label">
                                            <input
                                                type="checkbox"
                                                name="q_{{ q.id }}_opt_{{ opt.id }}"
                                                value="{{ opt.id }}"
                                                class="form-check-input"
                                                {% if ans and opt in ans.selected_options.all %}checked{% endif %}
                                            >
                                            <span class="custom-checkbox-mark"></span>
                                            {{ opt.text }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>

                        {% else %}
                            {# test içində açıq sual istəsən #}
                            <textarea
                                name="q_{{ q.id }}"
                                rows="4"
                                class="form-control"
                                placeholder="Cavabınızı yazın..."
                            >{% if ans %}{{ ans.text_answer }}{% endif %}</textarea>
                        {% endif %}

                    {# YAZILI / PRAKTİKİ imtahan – HƏMİŞƏ TEXTAREA #}
                    {% else %}
                        <textarea
                            name="q_{{ q.id }}"
                            rows="4"
                            class="form-control"
                            placeholder="Cavabınızı yazın..."
                        >{% if ans %}{{ ans.text_answer }}{% endif %}</textarea>
                    {% endif %}
                </li>
            {% endwith %}
        {% endfor %}
        </ol>

        <div class="form-actions">
            <button type="submit" name="submit_action" value="save" class="btn btn-secondary">
                <i class="fas fa-save"></i> Yadda saxla
            </button>
            <button type="submit" name="submit_action" value="finish" class="btn btn-primary">
                <i class="fas fa-flag-checkered"></i> İmtahanı bitir
            </button>
        </div>
    </form>
</div>

{# Timer üçün JavaScript - base.html faylında ola bilər, amma burda da yerləşdirə bilərəm #}
{% if remaining_seconds %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let remainingSeconds = {{ remaining_seconds }};
        const timerValueElement = document.getElementById('timer-value');
        const examForm = document.getElementById('exam-form');
        const saveButton = examForm.querySelector('button[name="submit_action"][value="save"]');
        const finishButton = examForm.querySelector('button[name="submit_action"][value="finish"]');

        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const pad = (num) => String(num).padStart(2, '0');

            if (hours > 0) {
                return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            } else {
                return `${pad(minutes)}:${pad(seconds)}`;
            }
        }

        function updateTimer() {
            if (remainingSeconds <= 0) {
                timerValueElement.textContent = "Vaxt bitdi!";
                clearInterval(timerInterval);
                // İmtahanı avtomatik göndərmək
                if (examForm) {
                    // "İmtahanı bitir" düyməsini simulyasiya edirik
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'submit_action';
                    hiddenInput.value = 'finish';
                    examForm.appendChild(hiddenInput);
                    examForm.submit();
                }
                return;
            }

            timerValueElement.textContent = formatTime(remainingSeconds);

            // Son 1 dəqiqə qaldıqda rəngi dəyiş
            if (remainingSeconds <= 60) {
                document.getElementById('exam-timer').classList.add('alert-danger');
                document.getElementById('exam-timer').classList.remove('alert-info');
            } else if (remainingSeconds <= 300) { // Son 5 dəqiqə
                document.getElementById('exam-timer').classList.add('alert-warning');
                document.getElementById('exam-timer').classList.remove('alert-info');
            }
            
            remainingSeconds--;
        }

        // Timeri hər saniyə yenilə
        const timerInterval = setInterval(updateTimer, 1000);
        updateTimer(); // Səhifə yüklənəndə bir dəfə dərhal yenilə

        // Formanın göndərilməsini tutub düyməni deaktiv etmək
        examForm.addEventListener('submit', function() {
            saveButton.disabled = true;
            finishButton.disabled = true;
            saveButton.textContent = 'Saxlanılır...';
            finishButton.textContent = 'Bitirilir...';
        });
    });
</script>
{% endif %}
{% endblock %}