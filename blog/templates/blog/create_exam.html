{% extends "base.html" %}
{% load static %}

{% block title %}Yeni imtahan{% endblock %}

{% block extraCss %}
    <link rel="stylesheet" href="{% static 'css/create_exam.css' %}">
{% endblock %}

{% block content %}
    <div class="create-exam-page-wrapper">
        <div class="create-exam-card">
            <div class="card-header">
                <h1>Yeni imtahan yarat</h1>
                <p>Tələbələr üçün yeni bir bilik yoxlaması hazırlayın.</p>
            </div>

            <form method="post" class="exam-form" novalidate>
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                    <div class="form-global-errors">
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                <div class="form-grid">
                    {# --- Başlıq --- #}
                    <div class="form-group span-full">
                        {{ form.title.label_tag }}
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="field-error">{{ form.title.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {# --- Təsvir --- #}
                    <div class="form-group span-full">
                        {{ form.description.label_tag }}
                        {{ form.description }}
                        <small class="form-text text-muted">
                            İmtahan haqqında qısa məlumat.
                        </small>
                        {% if form.description.errors %}
                            <div class="field-error">{{ form.description.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {# --- Tip + Aktivlik --- #}
                    <div class="form-group">
                        {{ form.exam_type.label_tag }}
                        {{ form.exam_type }}
                        {% if form.exam_type.errors %}
                            <div class="field-error">{{ form.exam_type.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group checkbox-group">
                        <label for="{{ form.is_active.id_for_label }}" class="checkbox-label-wrapper">
                            {{ form.is_active }}
                            <span class="custom-checkbox-box"></span>
                            {{ form.is_active.label }}
                        </label>
                        {% if form.is_active.errors %}
                            <div class="field-error">{{ form.is_active.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {# --- Vaxt parametrləri --- #}
                    <div class="form-group">
                        {{ form.total_duration_minutes.label_tag }}
                        <div class="input-with-icon">
                            {{ form.total_duration_minutes }}
                            <i class="far fa-clock icon"></i>
                        </div>
                        <small class="form-text text-muted">
                            Ümumi imtahan müddəti (dəqiqə). Boş buraxsan, ümumi limit olmayacaq.
                        </small>
                        {% if form.total_duration_minutes.errors %}
                            <div class="field-error">{{ form.total_duration_minutes.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        {{ form.default_question_time_seconds.label_tag }}
                        <div class="input-with-icon">
                            {{ form.default_question_time_seconds }}
                            <i class="fas fa-stopwatch icon"></i>
                        </div>
                        <small class="form-text text-muted">
                            Hər sual üçün varsayılan vaxt (saniyə). Boş buraxsan, sual-sual limit olmayacaq.
                        </small>
                        {% if form.default_question_time_seconds.errors %}
                            <div class="field-error">{{ form.default_question_time_seconds.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        {{ form.max_attempts_per_user.label_tag }}
                        <div class="input-with-icon">
                            {{ form.max_attempts_per_user }}
                            <i class="fas fa-redo icon"></i>
                        </div>
                        <small class="form-text text-muted">
                            Bir istifadəçi üçün maksimum cəhd sayı. Boş buraxsan, limitsiz olacaq.
                        </small>
                        {% if form.max_attempts_per_user.errors %}
                            <div class="field-error">{{ form.max_attempts_per_user.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {# ================= GİRİŞ HÜQUQLARI BLOKU ================= #}
                    <div class="form-section-title span-full">
                        <h2>Giriş hüquqları</h2>
                        <p>İmtahanı kimlərin görə biləcəyini burada idarə et.</p>
                    </div>

                    {# --- Hamı üçün açıq? --- #}
                    <div class="form-group checkbox-group span-full">
                        <label for="{{ form.is_public.id_for_label }}" class="checkbox-label-wrapper">
                            {{ form.is_public }}
                            <span class="custom-checkbox-box"></span>
                            <span>
                                Hamı üçün açıqdır?
                                <small class="checkbox-help">
                                    İşarələsən, bütün tələbələr imtahanı görə biləcək. 
                                    İşarəni götürsən, yalnız seçdiyin qrup və istifadəçilər görə bilər.
                                </small>
                            </span>
                        </label>
                        {% if form.is_public.errors %}
                            <div class="field-error">{{ form.is_public.errors.0 }}</div>
                        {% endif %}
                    </div>

        {# --- Məhdudlaşdırılmış giriş: Qruplar + fərdi user-lər --- #}
        <div id="access-restrictions" class="access-section span-full">
            <div class="access-section-grid">
                
                <div class="form-group custom-selector-group">
                    <label class="form-label-custom">İcazəli Qruplar</label>
                    
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="groupSearchInput" class="custom-search-input" placeholder="Qrup axtar...">
                    </div>

                    <div id="groupListContainer" class="custom-list-container">
                        <div class="loading-text">Yüklənir...</div>
                    </div>

                    <div class="selection-counter">
                        Seçilib: <span id="groupSelectedCount">0</span>
                    </div>

                    <div style="display: none;">
                        {{ form.allowed_groups }}
                    </div>
                    
                    {% if form.allowed_groups.errors %}
                        <div class="field-error">{{ form.allowed_groups.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group custom-selector-group">
                    <label class="form-label-custom">İcazəli Tələbələr (Fərdi)</label>
                    
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="userSearchInput" class="custom-search-input" placeholder="Tələbə axtar (ad, username)...">
                    </div>

                    <div id="userListContainer" class="custom-list-container">
                        <div class="loading-text">Yüklənir...</div>
                    </div>

                    <div class="selection-counter">
                        Seçilib: <span id="userSelectedCount">0</span>
                    </div>

                    <div style="display: none;">
                        {{ form.allowed_users }}
                    </div>

                    {% if form.allowed_users.errors %}
                        <div class="field-error">{{ form.allowed_users.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <p class="access-help mt-3">
                <i class="fas fa-info-circle me-1"></i>
                Əgər heç kim seçilməsə və "Hamı üçün açıq" deyilsə, imtahanı yalnız siz görə biləcəksiniz.
            </p>
        </div>

                    {# --- İmtahan kodu (optional) --- #}
                    <div class="form-group span-full">
                        {{ form.access_code.label_tag }}
                        <div class="input-with-icon">
                            {{ form.access_code }}
                            <i class="fas fa-key icon"></i>
                        </div>
                        <small class="form-text text-muted">
                            Optional: 6 rəqəmli kod yazsan, imtahana girməzdən əvvəl tələbədən bu kod tələb olunacaq.
                            Boş buraxsan, kod tələb olunmayacaq.
                        </small>
                        {% if form.access_code.errors %}
                            <div class="field-error">{{ form.access_code.errors.0 }}</div>
                        {% endif %}
                    </div>
                    {# ================= GİRİŞ HÜQUQLARI BLOKU SON ================= #}
                </div>

                <div class="form-actions">
                    <a href="javascript:history.back()" class="btn-cancel">Ləğv et</a>
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-check"></i> Yarat
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
    
            // ============================================================
            // 1. PUBLIC / PRIVATE TOGGLE (ANIMASİYALI GÖRÜNÜŞ)
            // ============================================================
            // Django formunun checkbox ID-sini və idarə olunacaq bloku tapırıq
            const isPublicCheckbox = document.getElementById("{{ form.is_public.id_for_label }}");
            const accessBlock = document.getElementById("access-restrictions");
    
            function toggleAccessBlock() {
                if (!isPublicCheckbox || !accessBlock) return;
                
                // Əgər "Hamı üçün açıq" seçilibsə -> Bloku bağla (.closed əlavə et)
                // Bu, CSS-dəki transition ilə animasiyalı bağlanacaq
                if (isPublicCheckbox.checked) {
                    accessBlock.classList.add('closed');
                } else {
                    // Əks halda bloku aç (.closed sil)
                    accessBlock.classList.remove('closed');
                }
            }
    
            if (isPublicCheckbox && accessBlock) {
                // Səhifə yüklənəndə vəziyyəti yoxla (Edit zamanı vacibdir)
                toggleAccessBlock();
                
                // Checkbox dəyişəndə funksiyanı yenidən çağır
                isPublicCheckbox.addEventListener("change", toggleAccessBlock);
            }
    
    
            // ============================================================
            // 2. SEARCHABLE MULTI-SELECT MƏNTİQİ (UNIVERSAL)
            // ============================================================
            /**
            * Bu funksiya Django-nun gizli select elementini oxuyur və 
            * bizim yaratdığımız Custom (checkbox-lu) siyahını qurur.
            */
            function setupCustomSelector(selectId, containerId, searchInputId, counterId) {
                // Elementləri tapırıq
                const hiddenSelect = document.getElementById(selectId);
                const container = document.getElementById(containerId);
                const searchInput = document.getElementById(searchInputId);
                const counterSpan = document.getElementById(counterId);
    
                // Əgər elementlər yoxdursa, heç nə etmə (xəta verməsin)
                if (!hiddenSelect || !container) return;
    
                // --- A) Siyahını Qurmaq ---
                function buildList() {
                    container.innerHTML = ''; // Siyahını təmizləyirik ki, dublikat olmasın
                    const options = Array.from(hiddenSelect.options);
    
                    if (options.length === 0) {
                        container.innerHTML = '<div class="loading-text">Məlumat tapılmadı.</div>';
                        return;
                    }
    
                    options.forEach(option => {
                        // Sətir (Row) yaradırıq
                        const row = document.createElement('div');
                        row.className = 'list-item-row';
                        // Axtarış üçün mətni kiçik hərflə data atributuna yazırıq
                        row.setAttribute('data-search', option.text.toLowerCase());
    
                        // Unikal ID yaradırıq (label və input əlaqəsi üçün)
                        const checkboxId = `cb_${selectId}_${option.value}`;
    
                        // HTML strukturunu qururuq
                        // option.selected ? 'checked' : '' -> Edit zamanı seçilənləri işarələyir
                        row.innerHTML = `
                            <input type="checkbox" id="${checkboxId}" class="custom-item-checkbox" value="${option.value}" ${option.selected ? 'checked' : ''}>
                            <label for="${checkboxId}" class="custom-item-label">${option.text}</label>
                        `;
    
                        // Checkbox elementini seçirik
                        const checkbox = row.querySelector('input');
    
                        // EVENT 1: Checkbox dəyişəndə
                        checkbox.addEventListener('change', function() {
                            // 1. Django-nun gizli select-ində uyğun option-u seçirik və ya seçimdən çıxarırıq
                            option.selected = this.checked;
                            // 2. Sayğacı yeniləyirik
                            updateCounter();
                        });
    
                        // EVENT 2: Sətrə (boşluğa) klikləyəndə də checkbox işləsin
                        row.addEventListener('click', function(e) {
                            // Əgər birbaşa checkboxa və ya label-a basılmayıbsa
                            if (e.target !== checkbox && e.target.tagName !== 'LABEL') {
                                checkbox.checked = !checkbox.checked;
                                // 'change' eventini əl ilə işə salırıq ki, yuxarıdakı məntiq işləsin
                                checkbox.dispatchEvent(new Event('change'));
                            }
                        });
    
                        container.appendChild(row);
                    });
                }
    
                // --- B) Sayğacı Yeniləmək ---
                function updateCounter() {
                    if (counterSpan) {
                        // Gizli select-də neçə dənə seçilibsə onu göstər
                        const count = hiddenSelect.selectedOptions.length;
                        counterSpan.textContent = count;
                    }
                }
    
                // --- C) Axtarış Məntiqi ---
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        const filter = this.value.toLowerCase();
                        const rows = container.querySelectorAll('.list-item-row');
    
                        rows.forEach(row => {
                            const text = row.getAttribute('data-search');
                            // Mətn uyğundursa göstər (flex), deyilsə gizlət (none)
                            if (text.includes(filter)) {
                                row.style.display = 'flex';
                            } else {
                                row.style.display = 'none';
                            }
                        });
                    });
                }
    
                // Başlanğıcda funksiyaları işə sal
                buildList();
                updateCounter();
            }
    
    
            // ============================================================
            // 3. FUNKSİYALARI İŞƏ SALMAQ
            // ============================================================
    
            // A) Qruplar üçün (Django ID: id_allowed_groups)
            setupCustomSelector(
                "id_allowed_groups",      // Gizli select ID
                "groupListContainer",     // Siyahı qutusu ID
                "groupSearchInput",       // Axtarış input ID
                "groupSelectedCount"      // Sayğac ID
            );
    
            // B) İstifadəçilər üçün (Django ID: id_allowed_users)
            setupCustomSelector(
                "id_allowed_users",       // Gizli select ID
                "userListContainer",      // Siyahı qutusu ID
                "userSearchInput",        // Axtarış input ID
                "userSelectedCount"       // Sayğac ID
            );
    
        });
    </script>


{% endblock %}
